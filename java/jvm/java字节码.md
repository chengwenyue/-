# Java 字节码技术

将一个.java 文件编译成 .class文件后就能得到一个字节码文件，比如源码如下：

```java 
package cwy.demo.jvm.bytecode;

public class ByteCodeDemo {
    private int a = 1;

    public int add(){
        int b = 2;
        int c = a + b;
        System.out.println(c);
        return c;
    }
}
```

编译后的字节码如下：

<img src="../../images/ByteCodeDemo.png" alt="ByteCodeDemo" style="zoom: 67%;" />

字节码按字节进行分割，一共分为10个部分，

1. 魔数
2. 版本号
3. 常量池
4. 访问标志
5. 当前类索引
6. 父类索引
7. 接口索引
8. 字段表
9. 方法表
10. 附加属性

## 1. 魔数和版本号

魔数是.class文件的前四个字节，内容为 'cafe babe' 译为 “咖啡宝贝”。JVM虚拟机在加载字节码时会根据前4个字节来判断一个.class文件是不是符合规则。

版本号是字节码的魔数后面的4个字节，分为两段，前两个字节为 **次版本号** 后两个字节为 **主版本号** 上文中的 00 00 00 34 对应的主版本号为 52 次版本号为 0，编译该文件的Java版本为 1.8.0。

## 2. 常量池

常量池分为两段，前一段是常量池数量，用2个字节表示，后一段是常量池的内容，由cp_info结构组成的集合。一个cp_info对应一个常量，一共有14种类型，如下图所示。

<img src="../../images/cp_info.png" alt="cp_info" style="zoom: 67%;" />



上面14种常量类型可以分为两大类，`字面量`和`符号引用`。如下表：

| 常量     | 具体的常量              |
| -------- | ----------------------- |
| 字面量   | 文本字符串              |
|          | 声明为final的常量基本值 |
| 符号引用 | 类和接口的全限定名      |
|          | 字段的名称和描述符      |
|          | 方法的名称和描述符      |

